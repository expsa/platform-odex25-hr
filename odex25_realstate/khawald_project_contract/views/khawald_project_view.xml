<?xml version="1.0" encoding="UTF-8" ?>
<odoo>
    <data>

        <!-- Installment -->
        <record id="contract_installment_form_view_inherit" model="ir.ui.view">
            <field name="name">Project Contract Installment</field>
            <field name="model">line.contract.installment</field>
            <field name="inherit_id" ref="contract.contract_installment_form_view"/>
            <field name="arch" type="xml">
                <xpath expr="//field[@name='due_date']" position="before">
                    <field name="project_id"  readonly="1" />
                    <field name="payment_type" readonly="1"/>
                </xpath>
            </field>
        </record>

        <record id="kh_project_contract_installment_form_view" model="ir.ui.view">
            <field name="name">Project Contract Installment</field>
            <field name="model">line.contract.installment</field>
            <field name="mode">primary</field>
            <field name="inherit_id" ref="contract.contract_installment_form_view"/>
            <field name="arch" type="xml">
                <xpath expr="//form" position="attributes">
                    <attribute name="create">false</attribute>
                    <attribute name="edit">false</attribute>
                    <attribute name="delete">false</attribute>
                </xpath>
            </field>
        </record>

        <record id="kh_project_contract_installment_tree_view" model="ir.ui.view">
            <field name="name">contract.installment.tree</field>
            <field name="model">line.contract.installment</field>
            <field name="mode">primary</field>
            <field name="inherit_id" ref="contract.contract_installment_tree_view"/>
            <field name="arch" type="xml">
                <xpath expr="//tree" position="attributes">
                    <attribute name="create">false</attribute>
                    <attribute name="edit">false</attribute>
                    <attribute name="delete">false</attribute>
                </xpath>
            </field>
        </record>

        <record id="contract_installment_search_view_inhert" model="ir.ui.view">
            <field name="name">contract.installment.search.view.inherit</field>
            <field name="model">line.contract.installment</field>
            <field name="inherit_id" ref="contract.contract_installment_search_view"/>
            <field name="arch" type="xml">
                <xpath expr="//filter[@name='group_by_state']" position="after">
                    <filter name="group_project_id" string="Project" domain="[]" context="{'group_by':'project_id'}"/>
                </xpath>
            </field>
        </record>

        <record model="ir.actions.act_window" id="action_project_installment_subcontractor">
            <field name="name">Subcontractor Installment</field>
            <field name="type">ir.actions.act_window</field>
            <field name="res_model">line.contract.installment</field>
            <field name="view_mode">tree,form</field>
            <field name="domain">[('payment_type','=','contractor')]</field>
            <field name="context">{'search_default_group_project_id': 1}</field>
            <field name="view_id" ref="kh_project_contract_installment_tree_view"/>
        </record>

        <record model="ir.actions.act_window" id="action_project_installment_engineering">
            <field name="name">Engineering Installment</field>
            <field name="type">ir.actions.act_window</field>
            <field name="res_model">line.contract.installment</field>
            <field name="view_mode">tree,form</field>
            <field name="domain">[('payment_type','=','engineering')]</field>
            <field name="context">{'search_default_group_project_id': 1}</field>
            <field name="view_id" ref="kh_project_contract_installment_tree_view"/>
        </record>


        <menuitem id="subcontractor_installment_menu" parent="project_management_custom.project_installment" action="action_project_installment_subcontractor" sequence="3"/>

        <menuitem id="engineering_installment_menu" parent="project_management_custom.project_installment" action="action_project_installment_engineering" sequence="4"/>


        <!-- Engineering -->
        <record id="contract_contract_form_view_engineering" model="ir.ui.view">
            <field name="name">Project Contract</field>
            <field name="model">contract.contract</field>
            <field name="mode">primary</field>
            <field name="inherit_id" ref="contract.contract_contract_form_view"/>
            <field name="arch" type="xml">
                <field name="partner_id" position="attributes">
                    <attribute name="string">Engineering</attribute>
                    <attribute name="domain">[('is_engineering_office', '=', True)]</attribute>
                    <attribute name="context">{'default_is_engineering_office': 1}</attribute>
                </field>

            </field>
        </record>

        <record id="project_engineering_contract_action" model="ir.actions.act_window">
            <field name="name">Project Engineering Contract</field>
            <field name="res_model">contract.contract</field>
            <field name="view_mode">tree,form</field>
            <field name="domain">[('project_id', '=', active_id ),('con_type', '=', 'engineering')]</field>
            <field name="context">{'search_default_project_id': [active_id],
                'default_project_id': active_id,
                'default_con_type':'engineering',
                'is_contract':1,
                'search_default_not_finished':1,
                'search_default_con_type':'engineering',
                'default_contract_type': 'sale'}
            </field>
        </record>

        <record id="project_action_customer_contract_view_tree_engineering" model="ir.actions.act_window.view">
            <field name="sequence" eval="1"/>
            <field name="view_mode">tree</field>
            <field name="view_id" ref="contract.contract_contract_tree_view"/>
            <field name="act_window_id" ref="project_engineering_contract_action"/>
        </record>

        <record id="project_action_customer_contract_view_form_engineering" model="ir.actions.act_window.view">
            <field name="sequence" eval="2"/>
            <field name="view_mode">form</field>
            <field name="view_id" ref="contract_contract_form_view_engineering"/>
            <field name="act_window_id" ref="project_engineering_contract_action"/>
        </record>


        <!-- contractor -->
        <record id="contract_contract_form_view_contractor" model="ir.ui.view">
            <field name="name">Project Contract</field>
            <field name="model">contract.contract</field>
            <field name="mode">primary</field>
            <field name="inherit_id" ref="contract.contract_contract_form_view"/>
            <field name="arch" type="xml">
                <field name="partner_id" position="attributes">
                    <attribute name="string">Contractor</attribute>
                    <attribute name="domain">[('is_subcontractor', '=', True)]</attribute>
                    <attribute name="context">{'default_is_subcontractor': 1}</attribute>
                </field>

            </field>
        </record>

        <record id="project_contractor_contract_action" model="ir.actions.act_window">
            <field name="name">Project Contractor Contract</field>
            <field name="res_model">contract.contract</field>
            <field name="view_mode">tree,form</field>
            <field name="domain">[('project_id', '=', active_id ),('con_type', '=', 'contractor')]</field>
            <field name="context">{'search_default_project_id': [active_id],
                'default_project_id': active_id,
                'default_con_type':'contractor',
                'is_contract':1,
                'search_default_not_finished':1,
                'search_default_con_type':'contractor',
                'default_contract_type': 'sale'}
            </field>
        </record>

        <record id="project_action_customer_contract_view_tree" model="ir.actions.act_window.view">
            <field name="sequence" eval="1"/>
            <field name="view_mode">tree</field>
            <field name="view_id" ref="contract.contract_contract_tree_view"/>
            <field name="act_window_id" ref="project_contractor_contract_action"/>
        </record>

        <record id="project_action_customer_contract_view_form" model="ir.actions.act_window.view">
            <field name="sequence" eval="2"/>
            <field name="view_mode">form</field>
            <field name="view_id" ref="contract_contract_form_view_contractor"/>
            <field name="act_window_id" ref="project_contractor_contract_action"/>
        </record>


        <!-- Contract -->
        <record id="khawald_contract_contract_form_view" model="ir.ui.view">
            <field name="name">Project Contract</field>
            <field name="model">contract.contract</field>
            <field name="inherit_id" ref="contract.contract_contract_form_view"/>
            <field name="arch" type="xml">
                <!-- <xpath expr="//button[@name='%(contract.action_installment_contract_lines)d']" context="{'project': project_id, 'payment_type':con_type}" position="attributes">
                    <attribute name="context"></attribute>
                    {'default_contract_id': contract_id, 'default_project_id': project_id, 'default_payment_type': payment_type}
                
                </xpath> -->

                <xpath expr="//button[@name='%(contract.action_installment_contract_lines)d']" context="{'project': project_id, 'payment_type':con_type}" position="replace">
                      <button name="get_installment" class="oe_stat_button" type="object" icon="fa-list" attrs="{'readonly':[('tax_id','=',False)], 'invisible': ['|',('type_of_contraction', '=', 'subs'),('total_amount','=',0)]}">
                            <field string="Installments" name="installment_count" widget="statinfo"/>
                        </button>
                </xpath>
                <xpath expr="//field[@name='partner_id']" position="after">
                    <field name="project_id" groups="project.group_project_manager" options="{'no_create' : True , 'no_edit' : True ,'no_open' : True}" required="0" attrs="{'readonly':[('con_type', 'in', ['contractor', 'engineering'])]}"/>
                    <field name="con_type" attrs="{'readonly':[('state','!=','new')]}" readonly="1" invisible="1"/>

                </xpath>

                <xpath expr="//field[@name='type_of_contraction']" position="attributes">
                    <attribute name="attrs">{'readonly':['|', ('state','!=','new'), ('project_id', '!=', False)]}</attribute>
                </xpath>


            </field>
        </record>


        <record id="contract_contract_search_view_inherit" model="ir.ui.view">
            <field name="name">Project Contract</field>
            <field name="model">contract.contract</field>
            <field name="inherit_id" ref="contract.contract_contract_search_view"/>
            <field name="arch" type="xml">
                <xpath expr="//field[@name='journal_id']" position="after">
                    <field name="project_id"/>
                    <field name="con_type"/>
                </xpath>
            </field>
        </record>


        <!-- Task -->
        <record id="kh_project_view_task_search_form" model="ir.ui.view">
            <field name="name">project.task</field>
            <field name="model">project.task</field>
            <field name="inherit_id" ref="project.view_task_search_form"/>
            <field name="arch" type="xml">
                <xpath expr="//filter[@name='activities_overdue']" position="after">
                    <!-- <filter string="Completed Task" name="completed_task" domain="
                                    [('state', '=', 'done')]"/> -->

                   <filter string="Expired Task" name="expired_task" domain="
                                    [('date_end','&lt;',context_today().strftime('%Y-%m-%d')), ('state', '!=', 'done')]"/>

                </xpath>
            </field>
        </record>

        <!-- <record id="kh_project_view_task_calendar" model="ir.ui.view">
            <field name="name">project.task</field>
            <field name="model">project.task</field>
            <field name="inherit_id" ref="project.view_task_calendar"/>
            <field name="arch" type="xml">
                <xpath expr="//field[@name='date_deadline']" position="replace">
                    <field name="date_start"/>
                    <field name="planned_date_begin"/>
                </xpath>
            </field>
        </record> -->

        <!-- Project -->
        <record id="khawald_edit_project_customs" model="ir.ui.view">
            <field name="name">Project</field>
            <field name="model">project.project</field>
            <field name="inherit_id" ref="project_management_custom.edit_project_customs"/>
            <field name="arch" type="xml">

                <xpath expr="//page[@name='engineering']/group" position="replace"/>
                <xpath expr="//page[@name='engineering']/group[1]" position="replace"/>

                <xpath expr="//field[@name='engineering_office_line_ids']" position="replace">
                    <button name="%(project_engineering_contract_action)d"  icon="fa-arrow-right" type="action"
                            string="Create Engineering Contract"
                            groups="project.group_project_manager"/>
                    
                    <field name="eng_contract_ids" readonly="1" domain="[('con_type', '=', 'engineering')]"/>
                    <field name="eng_installment_line_ids" readonly="1" domain="[('payment_type', '=', 'engineering')]"/>
                    
                </xpath>

                <xpath expr="//field[@name='subcontractor_work_ids']" position="replace">
                    <button name="%(project_contractor_contract_action)d" icon="fa-arrow-right" type="action"
                            string="Create Contractor Contract"
                            groups="project.group_project_manager"/>

                    <field name="cont_contract_ids" readonly="1" domain="[('con_type', '=', 'contractor')]"/>
                    <field name="con_installment_line_ids"  readonly="1" domain="[('payment_type', '=', 'contractor')]"/>
                    
                </xpath>

                <xpath expr="//button[@name='get_subcontractor_installment']" position="replace"/>

                <xpath expr="//button[@name='get_subcontractor_payment']" position="before">
                     <button class="oe_stat_button" name="get_contractor_contract" type="object" icon="fa-gavel">
                        <field string="Contractor Contract" name="con_contract_counts" widget="statinfo"/>
                    </button>
                     <button class="oe_stat_button" name="get_engineering_contract" type="object" icon="fa-gavel">
                        <field string="Engineering Contract" name="eng_contract_counts" widget="statinfo"/>
                    </button>
                </xpath>
            </field>
        </record>

        <delete id="project_management_custom.custom_project_payment_menu" model="ir.ui.menu"/>
        <delete id="project_management_custom.engineering_office_installment" model="ir.ui.menu"/>
        <delete id="project_management_custom.subcontractor_office_installment_menu" model="ir.ui.menu"/>
        <delete id="project_management_custom.subcontractor_installment_line_menu" model="ir.ui.menu"/>

    </data>
</odoo>